<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StockData Management Dashboard</title>
  <!-- External libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
/* Global Reset & Box Sizing */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* Root Variables */
:root {
  --primary: #2563eb;
  --primary-light: #3b82f6;
  --secondary: #475569;
  --success: #16a34a;
  --danger: #dc2626;
  --warning: #f59e0b;
  --light: #f8fafc;
  --dark: #1e293b;
  --border: #e2e8f0;
}

/* Global Styles */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f1f5f9;
  color: var(--dark);
  font-size: 14px;
  padding: 1rem; /* Ensures overall spacing */
}

/* Main Container */
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 1rem;
}

/* Header – ensuring elements align properly */
header {
  background-color: #fff;
  padding: 1rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  margin-bottom: 1.5rem;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}
header .brand {
  font-size: 1.75rem;
  font-weight: bold;
  color: var(--dark);
}
.status {
  font-size: 0.875rem;
  color: var(--secondary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap; /* Allow status items to wrap */
}
.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
}
.status-dot.loading {
  background-color: #ccc;
  animation: pulse 1.5s infinite ease-in-out;
}
.status-dot.success { background-color: var(--success); }
.status-dot.warning { background-color: var(--warning); }
.status-dot.error   { background-color: var(--danger); }
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.stats-card {
  background-color: #fff;
  border-left: 4px solid var(--primary);
  border-radius: 0.5rem;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  padding: 1rem;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.stats-label {
  font-size: 0.8rem;
  color: var(--secondary);
  margin-bottom: 0.3rem;
  text-transform: uppercase;
}
.stats-value {
  font-size: 1.4rem;
  font-weight: 600;
  color: var(--dark);
}

/* Main Grid Layout */
.main-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
}

/* Card Styles */
.card {
  background-color: #fff;
  border-radius: 0.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
  padding-bottom: 1rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}
h1, h2, h3 {
  margin: 0;
  color: var(--dark);
}
h2 { font-size: 1.25rem; }
h3 { font-size: 1.1rem; margin-bottom: 0.75rem; }

/* Tabs */
.tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  margin-bottom: 1rem;
}
.tab {
  padding: 0.75rem 1rem;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  color: var(--secondary);
}
.tab.active {
  border-bottom: 2px solid var(--primary);
  color: var(--primary);
  font-weight: 600;
}
.tab-content {
  display: none;
  padding: 1rem 0;
}
.tab-content.active { display: block; }

/* Buttons – unified size and transition effects */
.button {
  display: inline-block;
  padding: 0.5rem 1rem;
  border: 1px solid transparent;
  border-radius: 0.25rem;
  font-size: 0.875rem;
  text-align: center;
  cursor: pointer;
  min-width: 100px;
  transition: background-color 0.2s, border-color 0.2s;
}
.button-primary {
  background-color: var(--primary);
  color: #fff;
  border-color: var(--primary);
}
.button-primary:hover {
  background-color: var(--primary-light);
  border-color: var(--primary-light);
}
.button-outline {
  background-color: #fff;
  color: var(--primary);
  border: 1px solid var(--primary);
}
.button-outline:hover {
  background-color: #eff6ff;
}
.button-danger {
  background-color: var(--danger);
  color: #fff;
  border-color: var(--danger);
}
.button-danger:hover {
  background-color: #f87171;
  border-color: #f87171;
}
.button-group {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

/* Form Elements – consistent padding and border radius */
input[type="text"],
select {
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: 0.25rem;
  font-size: 0.875rem;
  /* Ensure consistent height */
  line-height: 1.5; /* Adjust based on font */
  height: calc(1.5em + 1rem + 2px); /* Match button height */
}

/* Ensure select dropdown arrow doesn't overlap */
select {
  padding-right: 1.5rem; /* Space for arrow */
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 0.8em auto;
  /* Consider adding a default arrow image if needed */
}

/* Tables */
.table-wrapper {
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
}
th, td {
  padding: 0.6rem 0.8rem;
  text-align: left;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
th {
  background-color: #f8fafc;
  font-weight: 600;
  color: var(--secondary);
}
tbody tr:hover {
  background-color: #f9fafb;
}
td.positive { color: var(--success); }
td.negative { color: var(--danger); }

/* Badges */
.badge {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 600;
  line-height: 1;
}
.badge-stock { background-color: #dbeafe; color: #1e40af; }
.badge-crypto { background-color: #fef3c7; color: #92400e; }
.badge-currency { background-color: #d1fae5; color: #065f46; }
.badge-derived { background-color: #e5e7eb; color: #4b5563; }
.badge-success { background-color: var(--success); color: #fff; }
.badge-warning { background-color: var(--warning); color: #fff; }
.badge-danger { background-color: var(--danger); color: #fff; }
.badge-unknown { background-color: #e5e7eb; color: #4b5563; } /* Added for safety */

/* Loading Overlay */
.loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 1rem;
  font-weight: 500;
  color: var(--secondary);
  z-index: 10;
  border-radius: 0.5rem;
}
.hidden { display: none; }

/* Pagination */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center; /* Vertically align buttons */
  gap: 5px;
  margin-top: 1rem;
  padding-bottom: 1rem;
}
.pagination button {
  padding: 5px 10px;
  border-radius: 4px;
  background-color: #f3f4f6;
  color: #374151;
  border: 1px solid #d1d5db;
  cursor: pointer;
  font-size: 0.8rem;
  line-height: 1.2; /* Ensure consistent height */
}
.pagination button:disabled {
  background-color: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
}
.pagination button.active {
  background-color: #2563eb;
  color: #fff;
  border-color: #2563eb;
}
.pagination span { /* Style for ellipsis */
  padding: 5px;
  color: var(--secondary);
}

/* Autocomplete Suggestions */
.autocomplete-suggestions {
  position: absolute;
  background-color: #fff;
  border: 1px solid var(--border);
  border-radius: 0.25rem;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  width: calc(100% - 2px); /* Default, JS might override */
  margin-top: 2px;
}
.autocomplete-suggestion {
  padding: 0.6rem 0.8rem;
  cursor: pointer;
  font-size: 0.875rem;
  display: flex; /* Use flex for better alignment */
  justify-content: space-between;
  align-items: center;
}
.autocomplete-suggestion:hover {
  background-color: #eff6ff;
}
.suggestion-main { display: flex; align-items: center; } /* Group ticker and source */
.suggestion-ticker { font-weight: 600; }
.suggestion-source { font-size: 0.8em; color: var(--secondary); margin-left: 5px; }
.suggestion-type { /* Adjusted to work with flex */
  font-size: 0.8em;
  margin-left: 10px; /* Add space between main part and type badge */
}

/* Meta-data Grid */
.meta-data-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  align-items: start;
  padding: 1rem 0; /* Add some vertical padding */
}
.meta-data-item {
  margin-bottom: 0.5rem;
  font-size: 0.875rem; /* Consistent font size */
  line-height: 1.4;
}
.meta-data-item strong { color: var(--dark); }
.meta-data-item code { /* Style for formula/context */
  background-color: #f1f5f9;
  padding: 0.2rem 0.4rem;
  border-radius: 0.25rem;
  font-size: 0.8em;
  word-break: break-all;
}

/* Chart Area Specific Styles */
.chart-controls {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.chart-controls label {
  font-size: 0.8rem;
  color: var(--secondary);
}

.timeframe-controls {
  margin-bottom: 1rem;
  display: flex;
  flex-wrap: wrap; /* Allow wrapping */
  gap: 0.5rem;
}
.timeframe-controls .button { /* Use button base class */
  min-width: 40px; /* Smaller min-width for timeframe buttons */
  padding: 0.3rem 0.6rem;
  background-color: #f3f4f6;
  color: #374151;
  border: 1px solid #d1d5db;
}
.timeframe-controls .button.active {
  background-color: var(--primary);
  color: #fff;
  border-color: var(--primary);
  font-weight: 600;
}
.timeframe-controls .button:hover:not(.active) {
  background-color: #e5e7eb;
}

.chart-container {
  position: relative;
  height: 350px;
  margin-bottom: 1.5rem;
}

/* Chart Stats Grid */
.chart-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.chart-stat-item {
  padding: 0.75rem; /* Consistent padding */
  background-color: var(--light);
  border-radius: 0.25rem;
}
.chart-stat-label {
  font-size: 0.75rem;
  color: var(--secondary);
  margin-bottom: 0.2rem;
  text-transform: uppercase;
}
.chart-stat-value {
  font-size: 1rem;
  font-weight: 600;
  color: var(--dark);
}
.chart-stat-value.positive { color: var(--success); }
.chart-stat-value.negative { color: var(--danger); }

/* System Status Section */
.status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.875rem;
  padding: 0.25rem 0; /* Add slight vertical padding */
}
.status-item span:first-child { color: var(--secondary); }
.status-detail { display: flex; align-items: center; gap: 0.5rem; }

.job-list {
  font-size: 0.875rem;
  color: var(--secondary);
  display: grid;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

/* Utility Classes */
.message-info { /* Added basic message styles */
  margin-top: 0.5rem;
  padding: 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.875rem;
}
.message-success {
  background-color: #d1fae5;
  color: #065f46;
  border: 1px solid #a7f3d0;
}
.message-error {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

/* Divider */
hr.divider {
  border: none;
  border-top: 1px solid var(--border);
  margin: 1.5rem 0; /* Consistent margin */
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  }
  .main-grid {
    grid-template-columns: 1fr;
  }
  header {
    flex-direction: column;
    align-items: flex-start;
  }
  .button-group {
    width: 100%;
    /* Ensure buttons wrap correctly */
  }
  .button {
    /* Allow buttons to take full width if needed, but maybe not always */
    /* width: 100%; */
    /* margin-bottom: 0.5rem; */
  }
  /* Ensure form controls stack nicely */
  .controls { flex-direction: column; align-items: stretch; }
  .controls input[type="text"], .controls select { width: 100%; }
  .autocomplete-suggestions {
      /* Ensure suggestions position correctly on mobile */
      width: 100%; /* Might need JS adjustment */
      left: 0 !important; /* Override JS if needed */
  }
}
</style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div class="brand">StockData Dashboard</div>
      <div class="status">
        <span id="service-status-dot" class="status-dot loading" title="Loading status..."></span>
        <span id="service-status-text">Services Status: Loading...</span>
      </div>
      <div class="status">
        <span>Last Cache Refresh: <span id="last-cache-refresh">Loading...</span></span>
        <span>| Next: <span id="next-cache-refresh">Loading...</span></span>
        <span>| Size: <span id="cache-size">?</span></span>
      </div>
    </header>

    <!-- Stats Grid -->
    <section class="stats-grid">
      <div class="stats-card">
        <div class="stats-label">Total Assets</div>
        <div class="stats-value" id="total-assets">Loading...</div>
      </div>
      <div class="stats-card">
        <div class="stats-label">Asset Quotes</div>
        <div class="stats-value" id="total-asset-quotes">Loading...</div>
      </div>
      <div class="stats-card">
        <div class="stats-label">Derived Tickers</div>
        <div class="stats-value" id="total-derived-tickers">Loading...</div>
      </div>
      <div class="stats-card">
        <div class="stats-label">OHLCV Records</div>
        <div class="stats-value" id="total-ohlcv-records">Loading...</div>
      </div>
      <div class="stats-card">
        <div class="stats-label">DB Size</div>
        <div class="stats-value" id="db-size">Loading...</div>
      </div>
      <div class="stats-card">
        <div class="stats-label">API Requests (Runtime)</div>
        <div class="stats-value" id="api-requests-runtime">Loading...</div>
      </div>
    </section>

    <!-- Main Content -->
    <section class="main-grid">
      <!-- Left Column -->
      <div>
        <!-- Data Management Card -->
        <div class="card">
          <div class="card-header">
            <h2>Data Management</h2>
            <div class="button-group">
              <button type="button" id="global-delta-sync-btn" class="button button-outline">Global Delta Sync</button>
              <button type="button" id="global-full-sync-btn" class="button button-danger" onclick="return confirm('Run Global Full Sync? This may take a long time and overwrite existing data.')">Global Full Sync</button>
            </div>
          </div>
          <div class="tabs">
            <div class="tab active" data-tab="db-summary">Database Summary</div>
            <div class="tab" data-tab="data-quality">Data Quality</div>
          </div>
          <div id="db-summary" class="tab-content active">
            <h3>Database Table Records</h3>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Table</th>
                    <th>Records</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="db-summary-body">
                  <tr><td colspan="3">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div id="data-quality" class="tab-content">
            <h3>Data Quality Metrics</h3>
            <div id="data-quality-content">Loading...</div>
          </div>

          <hr class="divider" />

          <div>
            <h3>Force Sync for Ticker</h3>
            <!-- Controls section for syncing specific ticker -->
            <div class="controls" style="position: relative;">
              <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.5rem;">
                <select id="sync-asset-type" title="Select Asset Type">
                  <option value="STOCK">STOCK</option>
                  <option value="CRYPTO">CRYPTO</option>
                  <option value="CURRENCY">CURRENCY</option>
                </select>
                <input type="text" id="sync-ticker-input" placeholder="Enter Ticker (e.g., AAPL, bitcoin, EUR)" style="flex-grow: 1; min-width: 200px;" />
              </div>
              <div id="sync-ticker-suggestions" class="autocomplete-suggestions"></div>
              <div class="button-group">
                <button type="button" id="force-full-sync-btn" class="button button-outline">Full Sync</button>
                <button type="button" id="force-delta-sync-btn" class="button button-primary">Delta Sync</button>
              </div>
            </div>
            <div id="sync-message" class="message-info"></div> <!-- Message area -->
          </div>

          <hr class="divider" />

          <div>
            <h3>Derived Tickers</h3>
            <p style="margin-bottom: 0.75rem; font-size: 0.875rem; color: var(--secondary);">Create and manage custom tickers based on formulas.</p>
            <a href="/derived_ticker_manager" target="_blank" class="button button-outline">Manage Derived Tickers</a>
          </div>
        </div>

        <!-- Ticker Traffic Card -->
        <div class="card">
          <div class="card-header">
            <h2>Top 200 Ticker Traffic (Runtime)</h2>
          </div>
          <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Ticker</th>
                  <th>Type</th>
                  <th>Query Count</th>
                </tr>
              </thead>
              <tbody id="ticker-traffic-body">
                <tr><td colspan="4">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div>
        <!-- Unified Ticker Data Preview Card -->
        <div class="card">
          <div class="card-header">
            <h2>Unified Ticker Data Preview</h2>
          </div>
          <!-- Controls for ticker search -->
          <div class="controls" style="position: relative; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;">
            <select id="asset-type-select" title="Filter suggestions by type (optional)">
              <option value="">All Types</option>
              <option value="STOCK">STOCK</option>
              <option value="CRYPTO">CRYPTO</option>
              <option value="CURRENCY">CURRENCY</option>
              <option value="DERIVED">DERIVED</option>
            </select>
            <input type="text" id="ticker-search-input" placeholder="Search Ticker (e.g., AAPL, BTCUSD, MY_DERIVED)" style="flex-grow: 1; min-width: 250px;" />
            <button type="button" id="ticker-search-btn" class="button button-primary">Search</button>
            <div id="ticker-search-suggestions" class="autocomplete-suggestions"></div>
          </div>

          <!-- Meta Data Display -->
          <div id="meta-data-content" class="meta-data-grid">
            Loading ticker details...
          </div>

          <hr class="divider" />

          <!-- Chart Section -->
          <div>
            <div class="card-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 0.5rem;">
              <h3 id="chart-title">Price Chart</h3>
              <div class="chart-controls">
                <label for="dataType">Data:</label>
                <select id="dataType">
                  <option value="value" selected>Value/Close</option>
                  <option value="open">Open Price</option>
                  <option value="high">High Price</option>
                  <option value="low">Low Price</option>
                  <!-- Derived value option might be added dynamically by JS if needed -->
                </select>
              </div>
            </div>
            <div class="timeframe-controls">
              <button type="button" class="button timeframe-button active" data-days="30">1M</button>
              <button type="button" class="button timeframe-button" data-days="90">3M</button>
              <button type="button" class="button timeframe-button" data-days="180">6M</button>
              <button type="button" class="button timeframe-button" data-days="365">1Y</button>
              <button type="button" class="button timeframe-button" data-days="730">2Y</button>
              <button type="button" class="button timeframe-button" data-days="1825">5Y</button>
              <button type="button" class="button timeframe-button" data-days="all">All</button>
            </div>
            <div class="chart-container">
              <canvas id="stockChart"></canvas>
              <div id="loadingIndicator" class="loading hidden">Loading chart data...</div>
            </div>

            <!-- Chart Stats -->
            <div class="chart-stats-grid">
              <div class="chart-stat-item">
                <div class="chart-stat-label">Period High</div>
                <div class="chart-stat-value" id="periodHigh">$0.00</div>
              </div>
              <div class="chart-stat-item">
                <div class="chart-stat-label">Period Low</div>
                <div class="chart-stat-value" id="periodLow">$0.00</div>
              </div>
              <div class="chart-stat-item">
                <div class="chart-stat-label">Average Volume</div>
                <div class="chart-stat-value" id="avgVolume">0</div>
              </div>
              <div class="chart-stat-item">
                <div class="chart-stat-label">Period Change</div>
                <div class="chart-stat-value" id="periodChange">0.00%</div> <!-- JS adds positive/negative class -->
              </div>
            </div>
          </div>

          <hr class="divider" />

          <!-- Recent Data Table Section -->
          <div>
            <h3>Recent Price Data</h3>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Open</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>Close/Value</th>
                    <th>Volume</th>
                    <th>Change %</th>
                  </tr>
                </thead>
                <tbody id="dataTableBody"></tbody>
              </table>
            </div>
            <div id="pagination" class="pagination"></div>
          </div>
        </div>

        <!-- System Status Card -->
        <div class="card">
          <div class="card-header">
            <h2>System Status</h2>
          </div>
          <div style="display: grid; gap: 1rem;">
            <div class="status-item">
              <span>Database Connection</span>
              <span id="db-status" class="status-detail"><span class="status-dot success"></span> Connected</span>
            </div>
            <div class="status-item">
              <span>Latest Cache Status</span>
              <span id="cache-status" class="status-detail"><span class="status-dot success"></span> Updated</span>
            </div>

            <hr class="divider" style="margin: 0.5rem 0;" />

            <div>
              <h4>API Stats (Runtime)</h4>
              <div style="font-size: 0.875rem; color: var(--secondary); margin-top: 0.5rem;">
                Total Requests: <span id="api-stats-total">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <!-- JavaScript -->
  <script>
    /* ----- TAB FUNCTIONALITY ----- */
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Deactivate existing active tab and content
        document.querySelector('.tab.active')?.classList.remove('active');
        document.querySelector('.tab-content.active')?.classList.remove('active');

        // Activate clicked tab and corresponding content
        tab.classList.add('active');
        const targetTabId = tab.getAttribute('data-tab');
        const targetTabContent = document.getElementById(targetTabId);
        if(targetTabContent) {
          targetTabContent.classList.add('active');
          // Conditionally fetch data if the tab requires it
          if (targetTabId === 'data-quality' && !targetTabContent.dataset.loaded) {
             fetchDataQuality();
             targetTabContent.dataset.loaded = true; // Mark as loaded
          }
        } else {
          console.error('Tab content not found for:', targetTabId);
        }
      });
    });

    /* ----- CACHE INFO ----- */
    function updateCacheInfo() {
      const cacheStatusSpan = document.getElementById('cache-status');
      const cacheStatusDot = cacheStatusSpan?.querySelector('.status-dot');
      const serviceStatusDot = document.getElementById('service-status-dot');
      const serviceStatusText = document.getElementById('service-status-text');

      fetch('/api/cache_info')
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          document.getElementById('last-cache-refresh').textContent = data.last_cache_refresh !== 'N/A' ? new Date(data.last_cache_refresh).toLocaleString() : "N/A";
          document.getElementById('next-cache-refresh').textContent = data.next_cache_refresh || "N/A";
          document.getElementById('cache-size').textContent = data.cache_size !== undefined ? data.cache_size : '?';

          if (cacheStatusDot) {
              if (data.last_cache_refresh) {
                const lastRefresh = new Date(data.last_cache_refresh);
                const now = new Date();
                const minutesSinceRefresh = (now - lastRefresh) / (1000 * 60);
                // Consider cache fresh if updated within ~5 minutes (adjust as needed)
                cacheStatusDot.className = minutesSinceRefresh < 5 ? 'status-dot success' : 'status-dot warning';
                cacheStatusSpan.childNodes[1].nodeValue = minutesSinceRefresh < 5 ? ' Updated' : ' Stale';
              } else {
                cacheStatusDot.className = 'status-dot warning';
                cacheStatusSpan.childNodes[1].nodeValue = ' Unknown';
              }
          }
          if(serviceStatusDot) serviceStatusDot.className = 'status-dot success';
          if(serviceStatusText) serviceStatusText.textContent = 'Services Status: Running';

          // Update scheduled job times if available
          if (data.scheduled_jobs) {
             document.getElementById('job-cache-refresh').textContent = data.scheduled_jobs.cache_refresh || 'N/A';
             document.getElementById('job-currency-cache').textContent = data.scheduled_jobs.currency_cache_refresh || 'N/A';
             document.getElementById('job-delta-stock').textContent = data.scheduled_jobs.delta_sync_stock || 'N/A';
             document.getElementById('job-delta-crypto').textContent = data.scheduled_jobs.delta_sync_crypto || 'N/A';
             document.getElementById('job-delta-currency').textContent = data.scheduled_jobs.delta_sync_currency || 'N/A';
             document.getElementById('job-query-save').textContent = data.scheduled_jobs.query_counter_save || 'N/A';
          }

        })
        .catch(error => {
          console.error('Error fetching cache info:', error);
          document.getElementById('last-cache-refresh').textContent = 'Error';
          document.getElementById('next-cache-refresh').textContent = 'Error';
          document.getElementById('cache-size').textContent = '?';
          if (cacheStatusDot) cacheStatusDot.className = 'status-dot error';
          if (cacheStatusSpan) cacheStatusSpan.childNodes[1].nodeValue = ' Error';
          if(serviceStatusDot) serviceStatusDot.className = 'status-dot error';
          if(serviceStatusText) serviceStatusText.textContent = 'Services Status: Error';
          // Reset job statuses on error
          ['job-cache-refresh', 'job-currency-cache', 'job-delta-stock', 'job-delta-crypto', 'job-delta-currency', 'job-query-save'].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.textContent = 'Error';
          });
        });
    }

    /* ----- DATA QUALITY ----- */
    function fetchDataQuality() {
      const contentDiv = document.getElementById('data-quality-content');
      contentDiv.innerHTML = 'Loading...';
      fetch('/api/data_quality')
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            contentDiv.innerHTML = `<p class="message-error">Error: ${data.error}</p>`;
            return;
          }
          // Simple list format for data quality metrics
          contentDiv.innerHTML = `
            <ul style="list-style: inside; padding-left: 0; display: grid; gap: 0.5rem;">
              <li>Total Assets: ${(data.total_assets ?? 0).toLocaleString()}</li>
              <li>Total Asset Quotes: ${(data.total_asset_quotes ?? 0).toLocaleString()}</li>
              <li>Total OHLCV Records: ${(data.total_ohlcv_records ?? 0).toLocaleString()}</li>
              <li>Assets Missing Name: ${(data.missing_name_assets ?? 0).toLocaleString()}</li>
              <!-- Add more metrics as needed -->
            </ul>
          `;
        })
        .catch(err => {
          console.error('Error fetching data quality:', err);
          contentDiv.innerHTML = `<p class="message-error">Error fetching data quality metrics.</p>`;
        });
    }

    /* ----- GLOBAL STATS ----- */
    function fetchGlobalStats() {
      const dbStatusSpan = document.getElementById('db-status');
      const dbStatusDot = dbStatusSpan?.querySelector('.status-dot');

      fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
          if (data.error) throw new Error(data.error);
          document.getElementById('total-assets').textContent = (data.total_assets ?? 0).toLocaleString();
          document.getElementById('total-asset-quotes').textContent = (data.total_asset_quotes ?? 0).toLocaleString();
          document.getElementById('total-derived-tickers').textContent = (data.total_derived_tickers ?? 0).toLocaleString();
          document.getElementById('total-ohlcv-records').textContent = (data.total_ohlcv_records ?? 0).toLocaleString();
          document.getElementById('db-size').textContent = data.db_size || 'N/A';
          document.getElementById('api-requests-runtime').textContent = (data.api_requests_total_runtime ?? 0).toLocaleString();
          document.getElementById('api-stats-total').textContent = (data.api_requests_total_runtime ?? 0).toLocaleString();

          const dbSummaryBody = document.getElementById('db-summary-body');
          dbSummaryBody.innerHTML = ''; // Clear loading state
          if (data.table_records) {
            const tableMapping = {
              assets: 'Assets',
              asset_quotes: 'Asset Quotes',
              asset_ohlcv: 'OHLCV Records',
              derived_tickers: 'Derived Tickers',
              delta_sync_state: 'Delta Sync State',
              query_counts: 'Query Counts'
            };
            for (const [key, value] of Object.entries(data.table_records)) {
              const label = tableMapping[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Format key nicely
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${label}</td>
                <td>${(value ?? 0).toLocaleString()}</td>
                <td><span class="badge badge-success">Available</span></td>
              `; // Simplified status
              dbSummaryBody.appendChild(row);
            }
          } else {
            dbSummaryBody.innerHTML = '<tr><td colspan="3">No table data available.</td></tr>';
          }
          if (dbStatusDot) dbStatusDot.className = 'status-dot success';
          if (dbStatusSpan) dbStatusSpan.childNodes[1].nodeValue = ' Connected';
        })
        .catch(err => {
          console.error('Error fetching stats:', err);
          // Set stats to 'Error' on failure
          ['total-assets', 'total-asset-quotes', 'total-derived-tickers', 'total-ohlcv-records', 'db-size', 'api-requests-runtime', 'api-stats-total'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.textContent = 'Error';
          });
          document.getElementById('db-summary-body').innerHTML = `<tr><td colspan="3" class="message-error">Error loading summary.</td></tr>`;
          if (dbStatusDot) dbStatusDot.className = 'status-dot error';
          if (dbStatusSpan) dbStatusSpan.childNodes[1].nodeValue = ' Error';
        });
    }

    /* ----- DEBOUNCE UTILITY ----- */
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    /* ----- AUTOCOMPLETE SETUP ----- */
    function setupAutocomplete(inputId, suggestionsId, assetTypeSelectorId, onSelectCallback = null) {
      const input = document.getElementById(inputId);
      const suggestionsContainer = document.getElementById(suggestionsId);
      const assetTypeSelect = document.getElementById(assetTypeSelectorId);

      // Debounced fetch function
      const fetchSuggestions = debounce(() => {
        const query = input.value.trim();
        const assetType = assetTypeSelect ? assetTypeSelect.value : '';
        if (query.length < 1) {
          suggestionsContainer.innerHTML = '';
          suggestionsContainer.style.display = 'none';
          return;
        }

        let apiUrl = `/api/tickers?query=${encodeURIComponent(query)}&limit=10&fuzzy=true`;
        if (assetType && assetType !== "ALL") { // Don't filter by type if ALL is selected
             apiUrl += `&asset_type=${assetType}`;
        }

        fetch(apiUrl)
          .then(response => response.json())
          .then(data => {
            suggestionsContainer.innerHTML = ''; // Clear previous suggestions
            if (data && data.length > 0) {
              data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                let sourceDisplay = item.source_ticker && item.source_ticker !== item.ticker
                  ? `<span class="suggestion-source">(${item.source_ticker})</span>`
                  : '';
                let typeBadgeClass = `badge-${(item.asset_type || 'unknown').toLowerCase()}`;

                // Use flex layout defined in CSS
                div.innerHTML = `
                  <span class="suggestion-main">
                     <span class="suggestion-ticker">${item.ticker}</span>
                     ${sourceDisplay}
                  </span>
                  <span class="badge ${typeBadgeClass} suggestion-type">${item.asset_type || 'N/A'}</span>
                `;

                div.addEventListener('click', () => {
                  input.value = item.ticker; // Set input value
                  suggestionsContainer.innerHTML = ''; // Clear suggestions
                  suggestionsContainer.style.display = 'none'; // Hide container
                  if (onSelectCallback) { onSelectCallback(item); } // Optional callback
                });
                suggestionsContainer.appendChild(div);
              });

              // Position the suggestions box below the input
              suggestionsContainer.style.display = 'block';
              // Get the input's parent element that has position:relative
              const positionedParent = input.closest('[style*="position: relative"]');
              if (positionedParent) {
                  const inputRect = input.getBoundingClientRect();
                  const parentRect = positionedParent.getBoundingClientRect();
                  suggestionsContainer.style.left = `${inputRect.left - parentRect.left}px`;
                  suggestionsContainer.style.top = `${inputRect.bottom - parentRect.top + 2}px`; // Position below input + 2px gap
                  suggestionsContainer.style.width = `${input.offsetWidth}px`;
              } else {
                  // Fallback positioning if no relative parent found (less ideal)
                  suggestionsContainer.style.left = `${input.offsetLeft}px`;
                  suggestionsContainer.style.top = `${input.offsetTop + input.offsetHeight + 2}px`;
                  suggestionsContainer.style.width = `${input.offsetWidth}px`;
              }

            } else {
              suggestionsContainer.style.display = 'none'; // Hide if no suggestions
            }
          })
          .catch(err => {
            console.error('Error fetching ticker suggestions:', err);
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.style.display = 'none';
          });
      }, 300); // 300ms debounce time

      input.addEventListener('input', fetchSuggestions);

      // Clear suggestions on type change
       if (assetTypeSelect) {
         assetTypeSelect.addEventListener('change', () => {
           suggestionsContainer.innerHTML = '';
           suggestionsContainer.style.display = 'none';
           // Optional: trigger a new search immediately if input has value
           // if (input.value.trim().length > 0) { fetchSuggestions(); }
         });
       }


      // Hide suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !suggestionsContainer.contains(e.target)) {
          suggestionsContainer.style.display = 'none';
        }
      });
    }

    // Setup autocomplete for both input fields
    setupAutocomplete('sync-ticker-input', 'sync-ticker-suggestions', 'sync-asset-type');
    setupAutocomplete('ticker-search-input', 'ticker-search-suggestions', 'asset-type-select', (selectedItem) => {
        // Optional: Automatically trigger search when a suggestion is clicked for the main search
        // document.getElementById('ticker-search-btn').click();
    });


    /* ----- GENERIC API CALL HANDLER ----- */
    function handleApiCall(url, method, body, messageElementId, buttonElement) {
      const messageElement = document.getElementById(messageElementId);
      if (!messageElement) {
        console.error("Message element not found:", messageElementId);
        return;
      }
      messageElement.textContent = 'Processing...';
      messageElement.className = 'message-info'; // Reset class
      if (buttonElement) buttonElement.disabled = true;

      fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : null
      })
      .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, body: data })))
      .then(({ ok, status, body }) => {
        if (ok) { // Check if response status is 2xx
          messageElement.textContent = body.message || 'Operation successful.';
          messageElement.className = 'message-info message-success'; // Add success class
        } else {
          // Use error message from API response, or provide a default
          messageElement.textContent = `Error (${status}): ${body.error || 'Unknown error occurred.'}`;
          messageElement.className = 'message-info message-error'; // Add error class
          console.error("API Error:", status, body);
        }
      })
      .catch(err => {
        messageElement.textContent = `Network or processing error: ${err.message}`;
        messageElement.className = 'message-info message-error'; // Add error class
        console.error('Fetch Error:', err);
      })
      .finally(() => {
        if (buttonElement) buttonElement.disabled = false;
        // Clear message after 5 seconds
        setTimeout(() => {
          // Only clear if it's not still showing "Processing..." (e.g., if another call started)
          if (messageElement.textContent !== 'Processing...') {
              messageElement.textContent = '';
              messageElement.className = 'message-info'; // Reset class
          }
        }, 5000);
      });
    }

    // --- Global Sync Button Handlers ---
    document.getElementById('global-delta-sync-btn').addEventListener('click', (e) => {
      handleApiCall('/api/sync/delta', 'POST', { /* asset_type handled server-side for global */ }, 'sync-message', e.target);
      alert("Global Delta Sync initiated for all applicable asset types."); // User feedback
    });

    document.getElementById('global-full-sync-btn').addEventListener('click', (e) => {
      // Confirmation is handled by onclick attribute in HTML
      handleApiCall('/api/sync/full', 'POST', { /* asset_type handled server-side for global */ }, 'sync-message', e.target);
      alert("Global Full Sync initiated for all applicable asset types. This may take a long time."); // User feedback
    });

    // --- Force Sync Button Handlers ---
    document.getElementById('force-full-sync-btn').addEventListener('click', (e) => {
      const ticker = document.getElementById('sync-ticker-input').value.trim();
      const assetType = document.getElementById('sync-asset-type').value; // Use selected type
      const messageElement = document.getElementById('sync-message');

      if (!ticker) {
        messageElement.textContent = 'Please enter a ticker.';
        messageElement.className = 'message-info message-error';
        return;
      }
      // Confirmation before proceeding
      if (!confirm(`Perform FULL sync for ${ticker}${assetType !== 'ALL' ? ' (' + assetType + ')' : ''}? This might take time and overwrite data.`)) { return; }

      const body = { ticker };
      if (assetType !== 'ALL') { body.asset_type = assetType; } // Only send asset_type if not 'ALL'

      handleApiCall('/api/sync/full', 'POST', body, 'sync-message', e.target);
    });

    document.getElementById('force-delta-sync-btn').addEventListener('click', (e) => {
      const ticker = document.getElementById('sync-ticker-input').value.trim();
      const assetType = document.getElementById('sync-asset-type').value; // Use selected type
      const messageElement = document.getElementById('sync-message');

      if (!ticker) {
        messageElement.textContent = 'Please enter a ticker.';
        messageElement.className = 'message-info message-error';
        return;
      }

      const body = { ticker };
      if (assetType !== 'ALL') { body.asset_type = assetType; } // Only send asset_type if not 'ALL'

      handleApiCall('/api/sync/delta', 'POST', body, 'sync-message', e.target);
    });

    /* ----- TICKER TRAFFIC ----- */
    function fetchTickerTraffic() {
      fetch('/api/ticker_traffic?limit=200') // Request limit from API
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById('ticker-traffic-body');
          tbody.innerHTML = ''; // Clear previous data or loading state
          if (data && data.length > 0) {
            data.forEach((item, index) => {
              let typeBadgeClass = `badge-${(item.asset_type || 'unknown').toLowerCase()}`;
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.ticker}</td>
                <td><span class="badge ${typeBadgeClass}">${item.asset_type || 'N/A'}</span></td>
                <td>${(item.count ?? 0).toLocaleString()}</td>
              `;
              tbody.appendChild(row);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="4">No traffic data available.</td></tr>';
          }
        })
        .catch(err => {
          console.error("Error fetching ticker traffic:", err);
          document.getElementById('ticker-traffic-body').innerHTML = '<tr><td colspan="4" class="message-error">Error loading traffic data.</td></tr>';
        });
    }

    /* ----- UNIFIED TICKER DATA PREVIEW & CHART ----- */
    let stockChart = null;
    let fullData = []; // Holds all data fetched from API for the current ticker
    let displayData = []; // Holds filtered data based on timeframe
    let currentPage = 1;
    const rowsPerPage = 10;

    // Formatting utility
    function formatValue(value, isCurrency = true, precision = 4) {
        if (value === null || value === undefined || value === "N/A" || value === "NOT_FOUND") return "N/A";
        if (typeof value !== 'number') return String(value); // Return non-numbers as string

        if (isCurrency) {
            if (Math.abs(value) >= 1) return '$' + value.toFixed(2);           // $1.23
            if (Math.abs(value) >= 0.01) return '$' + value.toFixed(4);       // $0.1234
            if (value === 0) return '$0.00';
            return '$' + value.toPrecision(precision);                        // $0.001234 or $1.234e-5
        } else {
            // Format large numbers with commas, handle decimals appropriately for non-currency
            return Number(value.toFixed(2)).toLocaleString(); // Basic formatting, adjust if needed
        }
    }

    // Fetch and display data for a specific ticker
    function fetchHistoricalData(ticker) {
      if (!ticker) return; // Don't fetch if ticker is empty

      const loadingIndicator = document.getElementById('loadingIndicator');
      const metaContent = document.getElementById('meta-data-content');
      const chartTitle = document.getElementById('chart-title');
      const dataTypeSelect = document.getElementById('dataType');
      const dataTableBody = document.getElementById('dataTableBody');
      const paginationContainer = document.getElementById('pagination');

      // Reset UI elements
      metaContent.innerHTML = '<div style="color: var(--secondary);">Loading ticker details...</div>';
      chartTitle.textContent = `Price Chart for ${ticker}`;
      loadingIndicator.classList.remove('hidden');
      if (stockChart) stockChart.destroy();
      stockChart = null; // Ensure chart is destroyed
      dataTableBody.innerHTML = '';
      paginationContainer.innerHTML = '';
      fullData = [];
      displayData = [];
      currentPage = 1;

      // Reset chart stats
      document.getElementById('periodHigh').textContent = 'N/A';
      document.getElementById('periodLow').textContent = 'N/A';
      document.getElementById('avgVolume').textContent = 'N/A';
      document.getElementById('periodChange').textContent = 'N/A';
      document.getElementById('periodChange').className = 'chart-stat-value';


      fetch(`/api/unified?ticker=${encodeURIComponent(ticker)}`)
        .then(response => {
          if (!response.ok) {
            // Try to parse error message from JSON response
            return response.json().then(err => {
                throw new Error(err.error || `Ticker not found or API error (${response.status})`);
            }).catch(() => {
                // If JSON parsing fails, throw generic error
                throw new Error(`Ticker not found or API error (${response.status})`);
            });
          }
          return response.json();
        })
        .then(data => {
          // --- Populate Meta Data ---
          let metaHtml = '';
          const isDerived = data.asset_type && data.asset_type.toUpperCase() === "DERIVED";
          let typeBadgeClass = `badge-${(data.from_asset?.asset_type || data.asset_type || 'unknown').toLowerCase()}`;

          metaHtml += `<div class="meta-data-item"><strong>Ticker:</strong> ${data.ticker} <span class="badge ${typeBadgeClass}">${data.asset_type || data.from_asset?.asset_type || 'N/A'}</span></div>`;

          if (isDerived) {
            metaHtml += `<div class="meta-data-item"><strong>Formula:</strong> <code>${data.formula || 'N/A'}</code></div>`;
            metaHtml += `<div class="meta-data-item"><strong>Latest Value:</strong> ${formatValue(data.latest_price)}</div>`;
            metaHtml += `<div class="meta-data-item"><strong>Calculated:</strong> ${data.latest_cache_timestamp ? new Date(data.latest_cache_timestamp).toLocaleString() : 'N/A'}</div>`;
            metaHtml += `<div class="meta-data-item" style="grid-column: 1 / -1;"><strong>Context:</strong> <code>${JSON.stringify(data.latest_context)}</code></div>`;
            // Disable irrelevant data types for derived tickers
            dataTypeSelect.value = 'value'; // Default to 'value'
            Array.from(dataTypeSelect.options).forEach(opt => { opt.disabled = (opt.value !== 'value'); });
          } else {
            metaHtml += `<div class="meta-data-item"><strong>Source Ticker:</strong> ${data.source_ticker || 'N/A'}</div>`;
            metaHtml += `<div class="meta-data-item"><strong>Data Source:</strong> ${data.data_source || 'N/A'}</div>`;
            metaHtml += `<div class="meta-data-item"><strong>Base Asset:</strong> ${data.from_asset?.symbol || 'N/A'}</div>`;
            metaHtml += `<div class="meta-data-item"><strong>Quote Asset:</strong> ${data.to_asset?.symbol || 'N/A'}</div>`;
            metaHtml += `<div class="meta-data-item"><strong>Latest Price:</strong> ${formatValue(data.latest_price)}</div>`;
            metaHtml += `<div class="meta-data-item"><strong>Cached Time:</strong> ${data.latest_cache_timestamp ? new Date(data.latest_cache_timestamp).toLocaleString() : 'N/A'}</div>`;
            // Enable relevant data types
            Array.from(dataTypeSelect.options).forEach(opt => { opt.disabled = false; });
            // If current selection is invalid, reset to 'value'
            if (dataTypeSelect.selectedOptions.length > 0 && dataTypeSelect.selectedOptions[0].disabled) {
                 dataTypeSelect.value = 'value';
            }
          }
          metaContent.innerHTML = metaHtml;
          chartTitle.textContent = `${data.ticker} Chart`; // Update chart title with loaded ticker

          // --- Process Historical Data ---
          if (!data.historical_data || data.historical_data.length === 0) {
            console.warn("No historical data received for ticker:", ticker);
            loadingIndicator.classList.add('hidden');
            dataTableBody.innerHTML = '<tr><td colspan="7">No historical data available for this ticker.</td></tr>';
            displayChartMessage("No historical data available");
            updateStats(); // Update stats to show N/A
            return;
          }

          // Process and sort data
          fullData = data.historical_data.map((item, index, arr) => {
              // Ensure numeric types
              item.open = item.open !== null ? Number(item.open) : null;
              item.high = item.high !== null ? Number(item.high) : null;
              item.low = item.low !== null ? Number(item.low) : null;
              item.close = item.close !== null ? Number(item.close) : null;
              item.volume = item.volume !== null ? Number(item.volume) : null;
              item.value = item.value !== null ? Number(item.value) : (item.close !== null ? item.close : null); // Fallback value to close
              item.date = item.date; // Assume date is already in usable format (e.g., ISO string)

              // Calculate change percentage from previous day's value/close
              if (index > 0) {
                const prevValue = arr[index - 1].value; // Use processed value from previous item
                item.change = (prevValue !== null && prevValue !== 0 && item.value !== null)
                                ? ((item.value - prevValue) / prevValue * 100)
                                : 0;
              } else {
                item.change = 0; // No change for the first data point
              }
              return item;
          }).sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort ascending by date

          // Apply default timeframe and update UI
          applyTimeframe(document.querySelector('.timeframe-button.active')?.dataset.days || '30'); // Use active button or default to 30 days
          updateChart();
          updateStats();
          updateDataTable();

        })
        .catch(err => {
          console.error('Error fetching historical data:', err);
          metaContent.innerHTML = `<p class="message-error">Error: ${err.message}</p>`;
          chartTitle.textContent = 'Error Loading Chart';
          if (stockChart) stockChart.destroy();
          stockChart = null;
          loadingIndicator.classList.add('hidden');
          dataTableBody.innerHTML = `<tr><td colspan="7" class="message-error">Error loading data.</td></tr>`;
          paginationContainer.innerHTML = '';
          displayChartMessage(`Error loading data: ${err.message}`);
          // Reset stats on error
          updateStats();
        });
    }

    // Helper to display messages on the chart canvas
    function displayChartMessage(message) {
        const ctx = document.getElementById('stockChart').getContext('2d');
        if (stockChart) stockChart.destroy();
        stockChart = null;
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.textAlign = 'center';
        ctx.fillStyle = '#dc2626'; // Error color
        ctx.font = '14px Segoe UI';
        ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
        document.getElementById('loadingIndicator').classList.add('hidden');
    }


    // Filter data based on selected timeframe (days or 'all')
    function applyTimeframe(daysOrLabel) {
      const days = daysOrLabel === 'all' ? Infinity : parseInt(daysOrLabel);
      if (isNaN(days)) {
        console.error("Invalid timeframe:", daysOrLabel);
        return;
      }

      if (!fullData || fullData.length === 0) {
        displayData = [];
        return;
      }

      if (days === Infinity) {
        displayData = [...fullData]; // Use all data
      } else {
        const cutoffDate = new Date();
        cutoffDate.setHours(0, 0, 0, 0); // Start of the day
        cutoffDate.setDate(cutoffDate.getDate() - days); // Go back specified days
        displayData = fullData.filter(item => new Date(item.date) >= cutoffDate);
      }
      currentPage = 1; // Reset to first page when timeframe changes
    }

    // Update the Chart.js chart
    function updateChart() {
      const dataType = document.getElementById('dataType').value;
      const ctx = document.getElementById('stockChart').getContext('2d');
      const loadingIndicator = document.getElementById('loadingIndicator');

      if (stockChart) { stockChart.destroy(); stockChart = null; }

      if (!displayData || displayData.length === 0) {
        loadingIndicator.classList.add('hidden');
        displayChartMessage("No data available for selected timeframe");
        return;
      }

      loadingIndicator.classList.remove('hidden'); // Show loading indicator during chart render

      // Prepare chart data, ensuring nulls are handled
      const chartValues = displayData.map(item => (item && item[dataType] !== undefined && item[dataType] !== null) ? Number(item[dataType]) : null);
      const labels = displayData.map(item => item.date);

      // Use setTimeout to allow the loading indicator to render before heavy chart work
      setTimeout(() => {
        try {
            stockChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: dataType.charAt(0).toUpperCase() + dataType.slice(1), // Capitalize label
                  data: chartValues,
                  borderColor: 'var(--primary)', // Use CSS variable
                  backgroundColor: 'rgba(37, 99, 235, 0.1)', // Use primary color with opacity
                  fill: true,
                  tension: 0.1, // Slight curve
                  pointRadius: displayData.length > 200 ? 0 : (displayData.length > 50 ? 1 : 2), // Adjust point size based on data density
                  pointHoverRadius: 4,
                  spanGaps: true, // Connect points across null gaps
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' }, // Tooltip triggers on hover over index
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: getTimeUnit(displayData.length),
                      tooltipFormat: 'MMM dd, yyyy', // Tooltip date format
                      displayFormats: { // Axis label formats
                        day: 'MMM dd',
                        week: 'MMM dd',
                        month: 'MMM yyyy',
                        quarter: '[Q]Q yyyy',
                        year: 'yyyy'
                      }
                    },
                    ticks: { maxRotation: 0, autoSkip: true, autoSkipPadding: 15 } // Improve label readability
                  },
                  y: {
                    beginAtZero: false, // Don't force y-axis to start at 0
                    ticks: {
                      callback: value => formatValue(value) // Format y-axis labels using utility
                    }
                  }
                },
                plugins: {
                  tooltip: {
                    callbacks: {
                      // Format the main label in the tooltip
                      label: context => `${context.dataset.label}: ${formatValue(context.raw)}`,
                      // Add OHLCV data to the tooltip body
                      afterBody: tooltipItems => {
                        const dataIndex = tooltipItems[0]?.dataIndex;
                        if (dataIndex === undefined || dataIndex >= displayData.length) return [];

                        const item = displayData[dataIndex];
                        if (!item) return [];

                        // Check if data looks like derived (missing OHLC)
                        const isDerivedLikely = item.open === null && item.high === null && item.low === null;

                        if (isDerivedLikely) {
                           return [`Value: ${formatValue(item.value)}`];
                        } else {
                           return [
                              `Open: ${formatValue(item.open)}`,
                              `High: ${formatValue(item.high)}`,
                              `Low: ${formatValue(item.low)}`,
                              `Close: ${formatValue(item.close)}`,
                              `Volume: ${formatValue(item.volume, false)}` // Don't format volume as currency
                           ];
                        }
                      }
                    }
                  },
                  legend: { display: false } // Hide legend as there's only one dataset
                },
                 // Hide chart initially until data is ready to avoid flickering
                 // Animation can be added here if desired
              }
            });
        } catch (error) {
             console.error("Chart.js error:", error);
             displayChartMessage("Error rendering chart");
        } finally {
            loadingIndicator.classList.add('hidden'); // Hide loading indicator after rendering attempt
        }
      }, 50); // Small delay
    }

    // Determine appropriate time unit for x-axis based on data length
    function getTimeUnit(dataLength) {
      if (dataLength <= 62) return 'day';    // ~2 months
      if (dataLength <= 180) return 'week';   // ~6 months
      if (dataLength <= 1095) return 'month'; // ~3 years
      return 'quarter';                     // Over 3 years
    }

    // Update the chart statistics boxes (High, Low, Volume, Change)
    function updateStats() {
      const periodHighEl = document.getElementById('periodHigh');
      const periodLowEl = document.getElementById('periodLow');
      const avgVolumeEl = document.getElementById('avgVolume');
      const periodChangeEl = document.getElementById('periodChange');

      // Reset stats if no display data
      if (!displayData || displayData.length === 0) {
        periodHighEl.textContent = 'N/A';
        periodLowEl.textContent = 'N/A';
        avgVolumeEl.textContent = 'N/A';
        periodChangeEl.textContent = 'N/A';
        periodChangeEl.className = 'chart-stat-value'; // Reset class
        return;
      }

      // Filter out null values before calculation
      const validHighs = displayData.map(item => item.high).filter(v => v !== null && !isNaN(v));
      const validLows = displayData.map(item => item.low).filter(v => v !== null && !isNaN(v));
      const validVolumes = displayData.map(item => item.volume).filter(v => v !== null && !isNaN(v));
      const validValues = displayData.map(item => item.value).filter(v => v !== null && !isNaN(v)); // Use 'value' for change calc

      // Calculate statistics
      const maxPrice = validHighs.length > 0 ? Math.max(...validHighs) : null;
      const minPrice = validLows.length > 0 ? Math.min(...validLows) : null;
      const avgVolume = validVolumes.length > 0 ? validVolumes.reduce((sum, v) => sum + v, 0) / validVolumes.length : null;

      const firstValue = validValues.length > 0 ? validValues[0] : null;
      const lastValue = validValues.length > 0 ? validValues[validValues.length - 1] : null;
      let periodChange = null;
      if (firstValue !== null && lastValue !== null && firstValue !== 0) {
        periodChange = ((lastValue - firstValue) / firstValue * 100);
      }

      // Update DOM elements
      periodHighEl.textContent = formatValue(maxPrice);
      periodLowEl.textContent = formatValue(minPrice);
      avgVolumeEl.textContent = formatValue(avgVolume, false); // Format volume without currency

      if (periodChange !== null) {
        periodChangeEl.textContent = periodChange.toFixed(2) + '%';
        periodChangeEl.classList.remove('positive', 'negative'); // Remove previous classes
        periodChangeEl.classList.add(periodChange >= 0 ? 'positive' : 'negative'); // Add appropriate class
      } else {
        periodChangeEl.textContent = 'N/A';
        periodChangeEl.className = 'chart-stat-value'; // Reset class
      }
    }

    // Update the table with recent price data and pagination
    function updateDataTable() {
      const tableBody = document.getElementById('dataTableBody');
      tableBody.innerHTML = ''; // Clear previous data

      if (!displayData || displayData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7">No data available for selected timeframe.</td></tr>';
        updatePagination(0); // Update pagination to show nothing
        return;
      }

      // Paginate the data (display latest data first)
      const displayDataReversed = [...displayData].reverse();
      const totalItems = displayDataReversed.length;
      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, totalItems);
      const pageData = displayDataReversed.slice(startIndex, endIndex);

      // Populate table rows
      pageData.forEach(item => {
        const row = document.createElement('tr');
        const changePercent = item.change !== null ? item.change.toFixed(2) : 0;
        const changeClass = changePercent > 0 ? 'positive' : (changePercent < 0 ? 'negative' : '');

        // Format values using the utility function
        const displayDate = item.date ? item.date.split('T')[0] : 'N/A'; // Show only date part
        const displayOpen = formatValue(item.open);
        const displayHigh = formatValue(item.high);
        const displayLow = formatValue(item.low);
        const displayClose = formatValue(item.value); // Use 'value' which might be 'close' or derived
        const displayVolume = formatValue(item.volume, false); // Non-currency formatting

        row.innerHTML = `
          <td>${displayDate}</td>
          <td>${displayOpen}</td>
          <td>${displayHigh}</td>
          <td>${displayLow}</td>
          <td>${displayClose}</td>
          <td>${displayVolume}</td>
          <td class="${changeClass}">${changePercent}%</td>
        `;
        tableBody.appendChild(row);
      });

      updatePagination(totalItems); // Update pagination controls
    }

    // Generate pagination buttons
    function updatePagination(totalItems) {
        const totalPages = Math.ceil(totalItems / rowsPerPage);
        const paginationContainer = document.getElementById('pagination');
        paginationContainer.innerHTML = ''; // Clear existing buttons

        if (totalPages <= 1) return; // No pagination needed for 0 or 1 page

        const maxButtonsToShow = 5; // Max number of page number buttons visible

        // Helper to create a button
        const createButton = (text, pageNum, isDisabled = false, isActive = false) => {
            const button = document.createElement('button');
            button.innerHTML = text; // Use innerHTML to render <<and>>
            button.disabled = isDisabled;
            if (isActive) button.classList.add('active');
            button.setAttribute('type', 'button'); // Explicitly set type
            button.addEventListener('click', () => {
                if (pageNum !== currentPage) { // Only update if page changed
                    currentPage = pageNum;
                    updateDataTable(); // Redraw table for the new page
                }
            });
            return button;
        };

        // "Previous" button
        paginationContainer.appendChild(createButton('&laquo;', currentPage - 1, currentPage === 1));

        // Calculate page number button range
        let startPage = Math.max(1, currentPage - Math.floor(maxButtonsToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxButtonsToShow - 1);

        // Adjust range if it's too small and there are more pages
        if (endPage - startPage + 1 < maxButtonsToShow) {
            startPage = Math.max(1, endPage - maxButtonsToShow + 1);
        }

        // Ellipsis and "1" if needed
        if (startPage > 1) {
            paginationContainer.appendChild(createButton('1', 1));
            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                paginationContainer.appendChild(ellipsis);
            }
        }

        // Page number buttons
        for (let i = startPage; i <= endPage; i++) {
            paginationContainer.appendChild(createButton(i, i, false, i === currentPage));
        }

        // Ellipsis and last page number if needed
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                paginationContainer.appendChild(ellipsis);
            }
            paginationContainer.appendChild(createButton(totalPages, totalPages));
        }

        // "Next" button
        paginationContainer.appendChild(createButton('&raquo;', currentPage + 1, currentPage === totalPages));
    }


    /* ----- INITIALIZATION ----- */
    document.addEventListener('DOMContentLoaded', () => {
      // Initial data fetches
      updateCacheInfo();
      fetchGlobalStats();
      fetchTickerTraffic();
      //fetchDataQuality(); // Fetch only when tab is clicked initially

      // Load default ticker data (e.g., AAPL)
      const initialTicker = 'AAPLUSD'; // Or load from URL param, localStorage, etc.
      document.getElementById('ticker-search-input').value = initialTicker;
      fetchHistoricalData(initialTicker);

      // --- Event Listeners ---

      // Ticker Search Button
      document.getElementById('ticker-search-btn').addEventListener('click', () => {
        const ticker = document.getElementById('ticker-search-input').value.trim();
        if (ticker) { fetchHistoricalData(ticker); }
      });

      // Ticker Search Input Enter Key
      document.getElementById('ticker-search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent potential form submission
            document.getElementById('ticker-search-btn').click();
        }
      });

      // Chart Data Type Select
      document.getElementById('dataType').addEventListener('change', () => {
        // Only update chart if data exists
        if (displayData && displayData.length > 0) { updateChart(); }
      });

      // Timeframe Buttons
      document.querySelectorAll('.timeframe-button').forEach(button => {
        button.addEventListener('click', function() {
          // Update active state
          document.querySelector('.timeframe-button.active')?.classList.remove('active');
          this.classList.add('active');

          const timeframe = this.dataset.days;
          applyTimeframe(timeframe); // Filter data based on new timeframe

          // Update chart and table if data exists
          if (fullData && fullData.length > 0) {
            updateChart();
            updateStats();
            updateDataTable();
          } else if (displayData.length === 0 && fullData.length > 0) {
             // Handle case where timeframe results in no data, but full data exists
             updateChart(); // Will display "no data for timeframe"
             updateStats();
             updateDataTable(); // Will display "no data for timeframe"
          }
        });
      });

      // --- Periodic Updates ---
      setInterval(updateCacheInfo, 60000); // Refresh cache/system info every minute
      setInterval(fetchTickerTraffic, 60000); // Refresh ticker traffic every minute
      // Consider adding interval for global stats if needed: setInterval(fetchGlobalStats, 300000); // Every 5 mins
    });
  </script>
</body>
</html>